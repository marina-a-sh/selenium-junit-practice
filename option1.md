### Option 1
**Run test cases<br>
by maven<br>
in dockerized Jenkins' agent to which Jenkins clones project's local git repository<br>
with browsers provided by dockerized Selenoid<br>
when Jenkins, Jenkins's agent, Selenoid and browsers are all on the same docker bridge network**

1. Start all containers
    - have recent Docker version from https://www.docker.com/ installed
    - pull jenkins image from https://hub.docker.com/r/jenkins/jenkins
      ```
      docker image pull jenkins/jenkins
      ```
    - download the latest configuration manager for Selenoid at https://aerokube.com/cm/latest/
      ```
      cm_linux_amd64 selenoid start --last-versions 1
      cm_linux_amd64 selenoid stop
      mkdir --parents [full_local_path]/selenoid_conf
      cp .aerokube/selenoid/browsers.json [full_local_path]/selenoid_conf
      vim [full_local_path]/selenoid_conf/browsers.json
      ```
    - change configuration to mount /dev/shm of the host to the container with Chrome to prevent [crash](https://github.com/markhobson/docker-maven-chrome#chrome-crashes)
      ```
      {
        "chrome": {
            "default": "109.0",
            "versions": {
                "109.0": {
                    "image": "selenoid/chrome:109.0",
                    "port": "4444",
                    "path": "/",
                    "volumes" : ["/dev/shm:/dev/shm"]
                }
            }
        },
        "firefox": {
        ...
      ```
    - start selenoid, selenoid-ui, and jenkinsci containers
      ```
      cm_linux_amd64 selenoid start --config-dir [full_local_path]/selenoid_conf --browsers-json [full_local_path]/selenoid_conf/browsers.json --vnc
      cm_linux_amd64 selenoid-ui start
      docker volume create jenkins-data    
      
      # if starting out of order, you may create network manually, otherwise it will be created by selenoid
      # docker network create --driver=bridge selenoid   
      
      docker container run --rm --detach --name jenkinsci -p 8085:8080 --network selenoid -v jenkins-data:/var/jenkins_home  --env JAVA_OPTS="-Dhudson.plugins.git.GitSCM.ALLOW_LOCAL_CHECKOUT=true" jenkins/jenkins:latest  
      
      # --rm                - automatically remove the container when it exits  
      # --detach            - run container in background and print container ID  
      # --name jenkinsci    - assign a name to the container  
      # -p 8085:8080        - publish a container's port (8080) to the host (8085)  
      # --network selenoid  - connect a container to a network  
      # -v jenkins-data:/var/jenkins_home  - mechanism for persisting data generated by and used by Docker containers  
      # --env JAVA_OPTS="-Dhudson.plugins.git.GitSCM.ALLOW_LOCAL_CHECKOUT=true" - allow local (from the same computer) checkouts
      ```
    - configure Jenkins' agent based on the tutorial at https://www.jenkins.io/doc/book/using/using-agents/ <br>
      To run agent container use the following command:
      ```
      docker run -d --rm --name=agent1 --network selenoid --network-alias agent -v [full_local_path_to_the_project]/selenium-junit-practice/:/qa -e "JENKINS_AGENT_SSH_PUBKEY=[your-public-key]" jenkins/ssh-agent:alpine
   
      # mount local directories and files to your container
      # -v [full_local_path_to_the_project]/selenium-junit-practice/:/qa:ro
      # optionally sync container time zone and host time zone
      # -v /etc/timezone:/etc/timezone:ro
      # -v /etc/localtime:/etc/localtime:ro
      # optionally mount external configuration file into the place of the project's configuration file
      # -v [full_path_on_the_host]/config.yml:/qa/src/test/resources/config.yml
      ```
    - Manually except SSH Host Key of 'agent1' on Jenkins controller<br>
        - Dashboard > Manage Jenkins > Manage Nodes and Clouds > click 'agent1'
        - click 'Relaunch agent'
        - on the sidebar click 'Trust SSH Host Key' and then 'Yes'
    - [Change time zone](https://wiki.alpinelinux.org/wiki/Setting_the_timezone) in selenoid container with Alpine Linux to get video file with local time in filenames:
      ```
      docker exec -u root -it selenoid /bin/sh
      apk add tzdata
      cp /usr/share/zoneinfo/America/Los_Angeles /etc/localtime
      echo "America/Los_Angeles" > /etc/timezone
      ```  

2. Expected state of project configuration file selenium-junit-practice/src/test/resources/config.yml
   ```
   browser: chrome    # or firefox or any browser supported by selenoid and selenium_junit_practice 
   environment: grid
   hub: http://selenoid:4444/wd/hub
   headless: false
   pageLoadTimeOut: 150 
   implicitTimeOut: 3
   explicitTimeOut: 10
   ```

3. Create job in Jenkins running on http://localhost:8085 and run it
    - Dashboard > Manage Jenkins > Manage Plugins > Available Plugins: search for junit and install  
      https://plugins.jenkins.io/junit/
    - Dashboard > Manage Jenkins > Manage Plugins > Available Plugins: search for junit-attachments and install   
      https://plugins.jenkins.io/junit-attachments/ <br>
      - Note: In maven site phase maven-ant-run plugin copies screenshots generated during test runs from 'target/artifacts' folder defined in the project into the folder structures expected by Jenkins Junit Attachments plugin like target/surefire-reports/org.groundwork.tests.ElementsStatsTest/failingTest.png)
    - Dashboard > Manage Jenkins > Script Console from 'Tools and Actions' section and type this command:
      ```
      System.setProperty("hudson.model.DirectoryBrowserSupport.CSP","default-src 'none'; img-src 'self'; style-src 'self'; child-src 'self'; frame-src 'self';")
      ```
      Click Run. <br>
      - Note 1: Without this step [junitreport's](https://ant.apache.org/manual/Tasks/junitreport.html) index.html page generated during maven site phase is shown with empty frames. <br>
      - Note 2: junitreport is updated with screenshots also copied from 'target/artifacts' to appropriate folders (like target/junitreport/org/groundwork/tests/ElementsStatsTest/failingTest.png) during site phase. It uses XSLT (XSL (eXtensible Stylesheet Language) Transformations) to produce the report from the XML files. Default junit-frames.xsl stylesheet from ant-optional is enhanced during site phase.
    - Dashboard > Manage Jenkins > Manage Plugins > Available Plugins: search for allure-jenkins-plugin and install   
      https://plugins.jenkins.io/allure-jenkins-plugin/  
      Jenkins needs to know where your Allure Commandline is installed. Please do so from the Global Tool Configuration (http://localhost:8085/configureTools/). Fill out name and install automatically from Maven Central.
    - Go to http://localhost:8085/systemInfo see current user.timezone  
      On the http://localhost:8085/user/admin/configure set 'User Defined Time Zone' to your preference.  
      - Note: Project internally uses "America/New_York" zone to deal with CNN site times.
    - Dashboard > New Item
    - Enter an item name: SeleniumJUnitPractice
    - Freestyle Project
      ```
      General
        Restrict where this project can be run
          Label Expression
            agent1
      Source Code Management
        Git
          Repositories
            Repository URL
              file:///qa      
            Credentials
              none
          Branches to build
            Branch Specifier (blank for 'any')
              */master
      Build Steps
        Invoke top-level Maven targets
          Maven version
            Maven 3.8.4
          Goals
            clean site
        Execute shell
          Command
            tar -czvf target.tar.gz target
      Post-build Actions
        AllureReport
          Path
            target/allure-results
        Archive the artifacts
          Files to archive
            target.tar.gz
        Publish JUnit test result report
          Test report XMLs
            **/target/surefire-reports/*.xml
          Additional test report features
            Publish test attachments 
      ```
      - Note: "Failed to connect to repository:" warning should be ignored. We mount local git repository to /qa folder of Jenkins agent, not Jenkins controller.
    - on the Dashboard click on the job's name SeleniumJUnitPractice, then 'Build Now'
    - (optional) To get xml representation of the Jenkins job
      ```
      curl -X GET http://localhost:8085/job/SeleniumJunitPractice/config.xml -su admin -o job_config.xml
      ```

4. See results (that include similar reports created by different approaches)
    - Find [console output](http://localhost:8085/job/SeleniumJunitPractice/lastCompletedBuild/console)
    - Find [Jenkins JUnit plugin's test report](http://localhost:8085/job/SeleniumJunitPractice/lastCompletedBuild/testReport)
    - Find [attachments added](http://localhost:8085/job/SeleniumJunitPractice/lastCompletedBuild/testReport/org.groundwork.tests/ElementsStatsTest/) by JUnit Attachments to the above report
    - Find *.mp4 videos recorded by selenoid in [full_local_path]/selenoid_conf/video folder
    - Find [project's workspace with target directory](http://localhost:8085/job/SeleniumJunitPractice/ws/)
    - Find [junitreport](http://localhost:8085/job/SeleniumJunitPractice/ws/target/junitreport/index.html) created in maven site phase with screenshots added to the reports in case of failure or error
    - Find screenshot attached to junitreport by clicking org.groundwork.tests > ElementsStatsTest > screenshot is added to the test named 'failingTest'
    - Fing [surefire-report](http://localhost:8085/job/SeleniumJunitPractice/ws/target/site/groundwork-practice-test-report.html)
    - Find [allure report](http://localhost:8085/job/SeleniumJunitPractice/allure/)
    - Find artifacts taken from agent and archived on Jenkins controller<br>
      ```
      docker exec -u root -it jenkinsci /bin/bash
      # change [build] to the build number and run
      cd /var/jenkins_home/jobs/SeleniumJunitPractice/builds/[build]/archive/
      ls
      # see target.tar.gz
      ```

5. Make optional investigations

   - see selenoid logs at http://localhost:4444/logs/
   - see detailed info about running containers
     ```
     docker container ls --no-trunc
     ```

   - run a command to launch Bash terminal within a running Jenkins agent container with Alpine Linux
      ```
     docker exec -u root -it agent1 /bin/bash
     cd workspace/SeleniumJunitPractice/
     ls
     # install and use networking tools to investigate while tests are running
     # 8889 is configured port of Jetty server
     # apk is the Alpine Package Keeper
     apk update          
     apk add iproute2
     ss -tunlp
     apk add busybox-extras
     telnet 0.0.0.0 8889
     telnet agent 8889
     exit
     ```

   - run a command to launch shell terminal within a running Selenoid container
     ```
     docker exec -u root -it selenoid /bin/sh
     # see browsers configuration file is as was given at selenoid's start: [full_local_path]/selenoid_conf/browsers.json
     cat /etc/selenoid/browsers.json
     ```

   - see details of Docker internal bridge network named 'selenoid'
     ```
     docker network inspect selenoid
     docker container ls
     ```
     while tests are running 6 containers based on the following images would be connected to this network:
       - aerokube/selenoid:latest
       - aerokube/selenoid-ui:dev-latest
       - selenoid/chrome:108.0
       - selenoid/video-recorder:latest-release
       - jenkins/jenkins:latest
       - jenkins/ssh-agent:alpine

   - containerized browser can be run manually and be sent manual 'WebDriver W3C' protocol requests to see behind the scenes
     ```
     docker run --rm -it -p9999:4444 selenoid/chrome:108.0 
     curl -X POST -H "Content-Type: application/json" -d '{"capabilities": {"alwaysMatch": {"platformName": "linux","chrome:browserOptions": {"binary": "/usr/bin/chromium","args": ["--start-page=about:blank"]}},"firstMatch": [{"browserName": "chrome"}]}}' http://localhost:9999/session
     curl -X POST -H "Content-Type: application/json" -d '{"url":"https://example.com"}' http://localhost:9999/session/[sessionID from response to the previous request]/url
     ```